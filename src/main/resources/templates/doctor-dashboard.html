<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Doctor Dashboard</title>
  <style>
    /* ====== Base Layout ====== */
    body { margin: 0; font-family: Arial, sans-serif; background-color: #f4f6f8; }
    .layout { display: flex; height: 100vh; }

    /* ====== Sidebar ====== */
    .sidebar { width: 250px; background-color: #fff; border-radius: 15px; color: #040404; font-size: 17px; font-weight: 550; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
    .sidebar h2 { font-size: 18px; margin-bottom: 5px; }
    .sidebar .info { margin-bottom: 30px; }
    .nav { display: flex; flex-direction: column; gap: 10px; }
    .nav .tab-btn { background: transparent; padding: 10px; border: none; color: #0c0c0c; font-size: 16px; text-align: left; cursor: pointer; border-radius: 6px; }
    .nav .tab-btn.active, .nav .tab-btn:hover { background-color: rgb(0, 0, 255); color: #fff; }

    .logout-btn { background-color: #ca1414; width: 150px; margin-left: 19%; border: 2px solid #000; border-radius: 15px; padding: 8px; font-size: 17px; color: #fff; cursor: pointer; }
    .logout-btn:hover { background-color: #b31010; }
	
	.opd-queue {
	  margin-top: 15px;
	  padding: 10px;
	  background-color: rgb(0, 0, 160);
	  color: white;
	  font-weight: bold;
	  border-radius: 8px;
	  text-align: center;
	  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
	}
	
	#opdBadge {
	  background: white;
	  color: #0c0c0c;
	  padding: 3px 8px;
	  border-radius: 12px;
	  margin-left: 5px;
	  font-size: 14px;
	}

    /* ====== Content ====== */
    .content { flex: 1; padding: 30px; overflow-y: auto; }
    .card { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.25s ease-in-out; }
    .card.show { opacity: 1; }

    .btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; color: #fff; }
    .btn-submit { background-color: rgb(5, 39, 63); }
    .btn-accept { background-color: rgb(5, 67, 32); }
    .btn-decline { background-color: rgb(82, 15, 7); }

    .appointment { border: 2px solid #aaa; border-radius: 15px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .loading-spinner { text-align: center; font-style: italic; color: #777; }

    input[type="text"], input[type="password"] { padding: 6px; border-radius: 5px; width: 100%; max-width: 300px; }
    .form-group { margin-bottom: 20px; }

    /* ====== Tab system (robust) ====== */
    .tabContent { display: none; }
    .tabContent.active { display: block; }
	

  </style>
</head>
<body>
<div class="layout">
  <!-- Doctor id for JS -->
  <div id="doctor-data" th:attr="data-id=${ID}"></div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="info">
        <h2>üë®‚Äç‚öïÔ∏è Dr. <span id="doctorName" th:text="${doctorName}">Doctor Name</span></h2>
        <p>üè• <span th:text="${hospitalName}">Hospital Name</span></p>
      </div>
      <nav class="nav" id="nav">
        <button class="tab-btn active" data-tab="newTab">New Appointments</button>
        <button class="tab-btn" data-tab="appointedTab">Appointed Patients</button>
        <button class="tab-btn" data-tab="treatedTab">Treatment Done</button>
        <button class="tab-btn" data-tab="detailsTab">My Details</button>
		<div class="opd-queue">
		  OPD Queue: <span id="opdBadge">0</span>
		</div>
      </nav>
    </div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </aside>

  <!-- Main content -->
  <main class="content">
    <!-- New Appointments -->
    <section id="newTab" class="tabContent active">
      <div class="card" id="newAppointmentsCard">
        <h3>New Appointments</h3>
        <div id="newAppointmentsContainer" class="card-body"></div>
      </div>
    </section>

    <!-- Appointed Patients -->
    <section id="appointedTab" class="tabContent">
      <div class="card" id="appointedAppointmentsCard">
        <h3>Appointed Patients</h3>
        <div id="appointedAppointmentsContainer" class="card-body"></div>
      </div>
    </section>

    <!-- Past Patients -->
    <section id="treatedTab" class="tabContent">
      <div class="card" id="treatedAppointmentsCard">
        <h3>Past Patients</h3>
        <div id="treatedAppointmentsContainer" class="card-body"></div>
      </div>
    </section>

    <!-- OPD Queue -->
    <section id="opdTab" class="tabContent">
      <div class="card" id="opdCard">
        <h3>OPD Queue</h3>
        <p>Total Patients in Queue: <strong id="totalPatients">0</strong></p>
        <p style="font-size: 12px; color:#666; margin-top:8px;">Last updated: <span id="opdUpdatedAt">‚Äî</span></p>
      </div>
    </section>

    <!-- My Details -->
    <section id="detailsTab" class="tabContent">
      <form id="detailsForm" class="card show">
        <h3>My Details</h3>
        <div class="form-group">
          <label>Name:</label>
          <input type="text" id="detailName" disabled />
        </div>
        <div class="form-group">
          <label>Contact:</label>
          <input type="text" id="detailContact" required />
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input type="text" id="detailEmail" required />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input type="password" id="detailPassword" />
        </div>
        <button type="submit" class="btn btn-submit">Save Changes</button>
      </form>
    </section>
  </main>
</div>

<script>
(() => {
  // ====== State ======
  let currentTabId = 'newTab';
  let opdIntervalId = null;
  let opdAbortController = null;

  // ====== Utilities ======
  const byId = (id) => document.getElementById(id);
  const qsAll = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

  function setCardVisible(cardEl, visible) {
    if (!cardEl) return;
    requestAnimationFrame(() => {
      if (visible) cardEl.classList.add('show');
      else cardEl.classList.remove('show');
    });
  }

  // ====== Tabs ======
  function showTab(tabId) {
    // Hide all tab contents
    qsAll('.tabContent').forEach(t => t.classList.remove('active'));
    // Show selected
    const selected = byId(tabId);
    if (!selected) return console.error(`Tab ${tabId} not found`);
    selected.classList.add('active');

    // Sidebar highlight
    qsAll('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tabId);
    });

    // Load data for the selected tab
    currentTabId = tabId;
    if (tabId === 'detailsTab') {
      loadDoctorDetails();
    } else {
      loadAppointmentsForCurrentTab();
    }
  }

  // ====== Appointments ======
  function fetchAppointmentsByStatus(status, containerId, actionButtonText, nextStatus) {
    const container = byId(containerId);
    const card = container.closest('.card');
    setCardVisible(card, false);
    container.innerHTML = `<div class="loading-spinner">Loading appointments...</div>`;

    const doctorName = byId("doctorName").innerText.trim();
    const encodedDoctorName = encodeURIComponent(doctorName);

    fetch(`/doctor/appointment/${status}/${encodedDoctorName}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(appointments => {
        container.innerHTML = '';
        if (!Array.isArray(appointments) || appointments.length === 0) {
          container.innerHTML = '<p>No appointments.</p>';
        } else {
          const frag = document.createDocumentFragment();
          appointments.forEach(app => {
            const div = document.createElement('div');
            div.className = 'appointment';
            div.innerHTML = `
              <div>
                <strong>${app.userName}</strong> (${app.userAge}, ${app.userGender})<br/>
                Disease: ${app.userDisease}<br/>
                Date: ${new Date(app.appointmentDate).toLocaleDateString()}<br/>
                Status: ${status === 0 ? 'Pending' : status === 1 ? 'Appointed' : 'Treated'}
              </div>
              <div>
                ${actionButtonText ? `<button class="btn btn-submit" data-app-id="${app.id}" data-next="${nextStatus}">${actionButtonText}</button>` : ''}
              </div>
            `;
            frag.appendChild(div);
          });
          container.appendChild(frag);
        }
        setCardVisible(card, true);
      })
      .catch(err => {
        console.error("Failed to load appointments", err);
        container.innerHTML = '<p>Error loading appointments.</p>';
        setCardVisible(card, true);
      });
  }

  function updateAppointmentStatus(id, status) {
    fetch(`/doctor/appointments/${id}/${status}`, { method: 'GET' })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        alert("Appointment status updated.");
        loadAppointmentsForCurrentTab();
      })
      .catch(err => {
        console.error("Error updating appointment", err);
        alert("Failed to update status.");
      });
  }

  function loadAppointmentsForCurrentTab() {
    if (currentTabId === 'newTab') {
      fetchAppointmentsByStatus(0, 'newAppointmentsContainer', 'Mark Appointed', 1);
    } else if (currentTabId === 'appointedTab') {
      fetchAppointmentsByStatus(1, 'appointedAppointmentsContainer', 'Mark Treated', 2);
    } else if (currentTabId === 'treatedTab') {
      fetchAppointmentsByStatus(2, 'treatedAppointmentsContainer', null, null);
    }
  }

  // Delegate click for action buttons inside appointment lists
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button.btn.btn-submit');
    if (!btn) return;
    const appId = btn.getAttribute('data-app-id');
    const next = btn.getAttribute('data-next');
    if (appId && next) {
      updateAppointmentStatus(parseInt(appId, 10), parseInt(next, 10));
    }
  });

  // ====== Details ======
  function loadDoctorDetails() {
    const id = byId('doctor-data').dataset.id;
    const doctorId = parseInt(id, 10);
    const formCard = byId('detailsForm').closest('.card');
    setCardVisible(formCard, false);

    fetch(`/doctor/details/${doctorId}`)
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        byId('detailName').value = data.name || '';
        byId('detailContact').value = data.contact || '';
        byId('detailEmail').value = data.email || '';
        setCardVisible(formCard, true);
      })
      .catch(err => {
        console.error("Error loading doctor details", err);
        alert("Could not load doctor details.");
        setCardVisible(formCard, true);
      });
  }

  byId('detailsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const contact = byId('detailContact').value;
    const email = byId('detailEmail').value;
    const password = byId('detailPassword').value;
    const id = byId('doctor-data').dataset.id;
    const doctorId = parseInt(id, 10);
    const payload = { contact, email };
    if (password.trim() !== '') payload.password = password;
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/doctor/update/${doctorId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
      body: JSON.stringify(payload)
    })
      .then(async res => {
        const text = await res.text();
        if (res.ok) {
          alert('Details updated.');
          byId('detailPassword').value = '';
        } else {
          alert('Failed to update details: ' + text);
        }
      })
      .catch(err => {
        console.error("Error updating doctor details", err);
        alert("Something went wrong.");
      });
  });

  // ====== OPD Queue (robust + auto refresh) ======
  function parseMaybeJson(text) {
    try {
      return JSON.parse(text);
    } catch {
      const n = parseInt(text, 10);
      return isNaN(n) ? null : n;
    }
  }

  function updateOPDBadge() {
    const doctorId = document.getElementById("doctor-data")?.dataset.id;
    if (!doctorId) return console.error("Doctor ID not found");
  
    fetch(`/doctor/count/${parseInt(doctorId)}`)
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById("opdBadge");
        if (!badge) return;
        const count = typeof data === "object" ? data.count : data;
        badge.textContent = count ?? "0";
      })
      .catch(err => console.error("Error loading OPD queue count", err));
  }
  
  // Refresh badge every 10 seconds
  setInterval(updateOPDBadge, 10000);
  
  // Load immediately on page load
  updateOPDBadge();


  // ====== Nav / Logout wiring ======
  byId('logoutBtn').addEventListener('click', () => {
    fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/login');
  });

  byId('nav').addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (!btn) return;
    const tabId = btn.dataset.tab;
    showTab(tabId);
  });

  // ====== Initial load ======
  // Default: show newTab and load its data
  showTab('newTab');
})();
</script>
</body>
</html>
